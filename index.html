<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 5‡∏™. - MM</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { font-family: 'Kanit', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #E0F7FA 0%, #E8F5E9 50%, #FFF8E1 100%); }
    .card-shadow { box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); }
    .floating { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    .pulse-btn { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(20, 184, 166, 0); } 100% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); } }
    .table-container { overflow-x: auto; max-height: 600px; }
    table th, table td { white-space: nowrap; border: 1px solid #e2e8f0; }
    .excellent { background: #4CAF50; color: white; }
    .fair { background: #FF9800; color: white; }
    .improve { background: #F44336; color: white; }
    .score-cell { min-width: 45px; text-align: center; font-weight: 500; }
    .header-group { background: #0D9488; color: white; }
    .sub-header { background: #CCFBF1; color: #134E4A; font-size: 0.75rem; }
    .sticky-col { position: sticky; background: white; z-index: 10; }
    .col-id { left: 0; min-width: 50px; }
    .col-area { left: 50px; min-width: 150px; text-align: left; padding-left: 12px; }
  </style>
 </head>
 <body class="h-full overflow-auto bg-gray-50">
  <div id="app" class="min-h-full">
   <div id="cover-page" class="min-h-full gradient-bg flex items-center justify-center p-4">
    <div class="text-center max-w-2xl mx-auto">
     <div class="mb-8">
      <span class="text-6xl floating inline-block">üèÜ</span>
      <span class="text-5xl floating inline-block mx-4" style="animation-delay: 0.5s;">üìä</span>
     </div>
     <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-8 md:p-12 card-shadow">
      <h1 class="text-2xl md:text-4xl font-bold text-gray-800 mb-4 leading-tight">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br><span class="text-teal-600">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° 5‡∏™. ‡πÅ‡∏ú‡∏ô‡∏Å MM</span></h1>
      <button onclick="showDashboard()" class="pulse-btn bg-teal-600 hover:bg-teal-700 text-white font-semibold py-4 px-10 rounded-2xl text-lg transition-all shadow-lg"> üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
     </div>
    </div>
   </div>

   <div id="dashboard-page" class="min-h-full hidden">
    <header class="bg-teal-700 text-white py-4 px-4 shadow-lg sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
       <button onclick="showCover()" class="bg-white/20 p-2 rounded-lg">üè†</button>
       <h1 class="text-xl font-bold">üìä Dashboard 5‡∏™. MM</h1>
      </div>
      <button onclick="fetchData()" class="bg-white text-teal-700 font-bold py-2 px-4 rounded-xl shadow-md transition-all active:scale-95"> üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
     </div>
    </header>

    <div class="max-w-full mx-auto px-4 py-6">
     <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-4 shadow-sm border-l-4 border-teal-500">
       <p class="text-gray-500 text-xs">üìç ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
       <p id="total-areas" class="text-2xl font-bold text-teal-600">-</p>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border-l-4 border-green-500">
       <p class="text-gray-500 text-xs">‚≠ê ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (>=90%)</p>
       <p id="excellent-count" class="text-2xl font-bold text-green-600">-</p>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border-l-4 border-yellow-500">
       <p class="text-gray-500 text-xs">üëç ‡∏û‡∏≠‡πÉ‡∏ä‡πâ (80-89%)</p>
       <p id="fair-count" class="text-2xl font-bold text-yellow-600">-</p>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm border-l-4 border-red-500">
       <p class="text-gray-500 text-xs">‚ö†Ô∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (<80%)</p>
       <p id="improve-count" class="text-2xl font-bold text-red-600">-</p>
      </div>
     </div>

     <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
      <div class="table-container">
       <table id="score-table" class="w-full text-sm border-collapse">
        <thead id="table-head"></thead>
        <tbody id="table-body">
         <tr><td colspan="18" class="text-center py-20 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
        </tbody>
       </table>
      </div>
     </div>
     <p class="mt-4 text-center text-xs text-gray-400">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="last-update">-</span></p>
    </div>
   </div>
  </div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcXVMdQ-xx6kk472PuUsusE6BuKtzbdHIdkMj2Qmmj0ZYUugLDN88buiJ8BtPULBDA/exec';
    const STORAGE_KEY = '5s_mm_data';

    function showDashboard() {
      document.getElementById('cover-page').classList.add('hidden');
      document.getElementById('dashboard-page').classList.remove('hidden');
      const cached = localStorage.getItem(STORAGE_KEY);
      if (cached) {
        renderData(JSON.parse(cached).data);
        document.getElementById('last-update').textContent = JSON.parse(cached).time;
      }
      fetchData(); // ‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    }

    function showCover() {
      document.getElementById('dashboard-page').classList.add('hidden');
      document.getElementById('cover-page').classList.remove('hidden');
    }

    function fetchData() {
      const script = document.createElement('script');
      script.src = `${APPS_SCRIPT_URL}?callback=handleResponse&t=${Date.now()}`;
      document.body.appendChild(script);
    }

    window.handleResponse = function(res) {
      if (res.values) {
        const now = new Date().toLocaleString('th-TH');
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ data: res, time: now }));
        renderData(res);
        document.getElementById('last-update').textContent = now;
      }
    };

    function renderData(res) {
      const values = res.values;
      const head = document.getElementById('table-head');
      const body = document.getElementById('table-body');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Fix ‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢)
      head.innerHTML = `
        <tr class="header-group">
          <th rowspan="2" class="sticky-col col-id bg-teal-800">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th rowspan="2" class="sticky-col col-area bg-teal-800">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
          <th colspan="4" class="bg-blue-600">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1</th>
          <th colspan="4" class="bg-green-600">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2</th>
          <th colspan="4" class="bg-yellow-600 text-gray-800">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3</th>
          <th colspan="4" class="bg-orange-600">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 4</th>
        </tr>
        <tr class="sub-header">
          ${'<th>SM</th><th>EN</th><th>BS</th><th>PD</th>'.repeat(4)}
        </tr>
      `;

      let bodyHTML = '';
      let stats = { total: 0, exc: 0, fair: 0, imp: 0 };

      values.forEach((row, index) => {
        if (!row[1]) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á
        const areaName = row[1].toString().trim();
        
        // --- ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ã‡πâ‡∏≥ (‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ß) ---
        if (areaName === '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà' || areaName === 'SM' || areaName.includes('‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà') || index < 2) return;

        const isSummary = areaName.includes('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°') || areaName.includes('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°') || areaName.includes('%');
        let rowClass = isSummary ? 'bg-teal-50 font-bold' : 'hover:bg-teal-50';
        
        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÅ‡∏ñ‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö)
        if (!isNaN(parseInt(row[0])) && !isSummary) stats.total++;

        bodyHTML += `<tr class="${rowClass}">`;
        bodyHTML += `<td class="sticky-col col-id text-center ${isSummary?'bg-teal-50':'bg-white'}">${row[0] || ''}</td>`;
        bodyHTML += `<td class="sticky-col col-area ${isSummary?'bg-teal-50':'bg-white'}">${areaName}</td>`;

        for (let i = 2; i < 18; i++) {
          let val = row[i] || '';
          let cellClass = 'score-cell';
          
          if (areaName.includes('%') && val !== '') {
            const num = parseFloat(val);
            if (!isNaN(num)) {
              if (num >= 90) { cellClass += ' excellent'; stats.exc++; }
              else if (num >= 80) { cellClass += ' fair'; stats.fair++; }
              else { cellClass += ' improve'; stats.imp++; }
              val = Math.round(num) + '%';
            }
          }
          bodyHTML += `<td class="${cellClass}">${val}</td>`;
        }
        bodyHTML += '</tr>';
      });

      body.innerHTML = bodyHTML;
      document.getElementById('total-areas').textContent = stats.total;
      document.getElementById('excellent-count').textContent = stats.exc;
      document.getElementById('fair-count').textContent = stats.fair;
      document.getElementById('improve-count').textContent = stats.imp;
    }
  </script>
 </body>
</html>
